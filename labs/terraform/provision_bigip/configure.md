## Configure the BIG-IP
In this section, we will use the [F5 VSCode extension](https://f5devcentral.github.io/vscode-f5/#/) to configure our new BIG-IP.

## Add F5 Host
To configure the BIG-IP we need to make the F5 VSCode extension aware of our new BIG-IP deployment.  
You will need to collect two variables from the Terraform output:
- mgmtPublicIP
- bigip_password

To obtain these values run the following commands in your terminal:
```bash
echo `terraform output -json | jq ".mgmtPublicIP.value[0][0]" -r`
echo `terraform output -json | jq ".bigip_password.value[0]" -r`
```

To add the new BIG-IP host to the F5 VSCode extension: 
1. In your VSCode instance, click on the F5 ball in the left hand menu 
2. Click *Add Host* in the *F5 Hosts* pannel
3. In the pop-up window, enter admin@your_ip_address then press enter/return 
4. Double-click on the BIG-IP under the *F5 Hosts* pannel
5. Enter the password in the pop-up window

Once the BIG-IP is added you will notice more information is available in VSCode about the BIG-IP:
- Installed Automation Toolchain components and versions (lower blue bar)
- AS3 tenants and tasks
- Installed iRules and iApps as well as deployed iApps

## Onboard BIG-IP
Now that the F5 VSCode extension is connected to our new BIG-IP we can leveraged the DO declaration generated by Terraform to onboard the virtual appliance. 

1. In VSCode, open the DO declaration: *DO_3nic-instance3.json*
     - the file will be located under *~/projects/learning-week/labs/terraform/provision_bigip/aws/*
2. Select all text in the declaration 
3. Right-click the text and click *Post as DO Declaration*

You wil notice a new window pop-up in the bottom right corner with the DO declaration POST status

When the DO task is completed, you will see a new text window appear in VSCode with the DO task response payload.  You should see a *result* element with a *status* variable of *OK*. 
```json
{
    "id": "b339d081-c58a-4bd9-892a-163399f28b8c",
    "selfLink": "https://localhost/mgmt/shared/declarative-onboarding/task/b339d081-c58a-4bd9-892a-163399f28b8c",
    "result": {
        "class": "Result",
        "code": 200,
        "status": "OK",
        "message": "success"
    },
```

## Configure Test Application
Now that our BIG-IP is deployed and onboarded we are ready to configure a test application.

To configure our application we need to determine the allocated IP address for our virtual server and associate the AWS Elastic IP:
```bash
export vip_private_address=`terraform output -json | jq '.private_addresses.value[0][0][0]' -r`
export vip_instance_id=`aws ec2 describe-instances | jq '.Reservations[0].Instances[0].InstanceId' -r`
export vip_eni=`aws ec2 describe-instances | jq '.Reservations[0].Instances[0].NetworkInterfaces[] | select(.PrivateIpAddress | contains("10.0.2.")) | .NetworkInterfaceId' -r`
export allocation_id=`aws ec2 describe-addresses | jq '.Addresses[] | select(.NetworkInterfaceId | contains($vip_eni)) | .AllocationId' --arg vip_eni "$vip_eni" -r`
aws ec2 associate-address --allocation-id $allocation_id --network-interface-id $vip_eni --private-ip-address $vip_private_address
```
Now we can prepare the AS3 declaration by updating the AS3 VirtualAddresses to match the VIP private IP address determined in the previous step:
```bash
sed -i "s/{{VIP_ADDRESS}}/$vip_private_address/g" demo.as3.json
```

Now we can post the AS3 declaration to the BIG-IP:
1. In VSCode, open the AS3 declaration: *demo.as3.json*
     - the file will be located under *~/projects/learning-week/labs/terraform/provision_bigip/aws/*
2. Select all text in the declaration 
3. Right-click the text and click *Post as AS3 Declaration*

## Test Application
Now that the BIG-IP is configured with your demo application, we will leverage InSpec to validate that the application is working correctly:
```bash
export demo_eip=`aws ec2 describe-addresses | jq '.Addresses[] | select(.AllocationId | contains($allocation_id)) | .PublicIp' --arg allocation_id "$allocation_id" -r`

inspec exec tests/demo-app --input=demo_app=$demo_eip
```

You should see an InSpec test summary that shows the test was successful:
```bash
Profile: InSpec Profile (demo-app)
Version: 0.1.0
Target:  local://

  ✔  demo app: HTTP GET on http://44.234.225.16
     ✔  HTTP GET on http://44.234.225.16 status is expected to cmp == 200


Profile Summary: 1 successful control, 0 control failures, 0 controls skipped
Test Summary: 1 successful, 0 failures, 0 skipped
```
